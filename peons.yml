---

# If it can do this 10 times, consider the peon up/functional
- hosts: peons:&{{ adept_job }}
  gather_facts: False
  strategy: free
  vars:
    needs_reboot: False
  pre_tasks:
    - debug: msg="Verifying peons remain accessable for 10-second period"
    - include: roles/peon/tasks/try_sleep.yml
      with_sequence: start=0 end=10
    - setup:
  roles:
    - subscribed

- hosts: peons:&partitioned:&{{ adept_job }}
  roles:
    - partitioned

- hosts: peons:&rebooted:&{{ adept_job }}
  roles:
    - rebooted

- hosts: peons:&yumrepos:&{{ adept_job }}
  roles:
    - yumrepos

# TODO: Apply all/most roles by conditional instead
#       of group-membership.  Similar to below.
- hosts: peons:&{{ adept_job }}
  roles:
    - role: lvm
      when: lvg_ops is defined or lvol_ops is defined

    - role: swap_enabled
      when: swap_device is defined

- hosts: peons:&installed:&{{ adept_job }}
  roles:
    - installed

- hosts: peons:&updated:&{{ adept_job }}
  roles:
    - updated

- hosts: peons:&atomic_upgrade:&{{ adept_job }}
  roles:
    - atomic_upgrade

- hosts: peons:rebooted:&{{ adept_job }}
  roles:
    - rebooted

- hosts: peons:&{{ adept_job }}
  roles:
    - peon
    - role: docker-storage-setup
      when: sysconfig_dss_lines != [] or sysconfig_dss_template != ""
    - sysconfig_docker
    - services

- hosts: peons:rebooted:&{{ adept_job }}
  roles:
    - rebooted
